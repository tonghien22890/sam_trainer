# ğŸ¯ AI-Sam Model Build - Complete ML Solution

This module contains **two specialized ML models** for Vietnamese card games:

1. **Hybrid Conservative BÃ¡o SÃ¢m Model** - BÃ¡o SÃ¢m declarations with high precision
2. **Optimized General Gameplay Model V3** - General gameplay decisions with a per-candidate ranking model

## ğŸ—ï¸ Solution Overview

### **BÃ¡o SÃ¢m Model:**
- **Algorithm**: Decision Tree Classifier vá»›i conservative configuration
- **Approach**: Hybrid ML + Rule-based system
- **Performance**: 98.7% precision, 100% accuracy trÃªn test scenarios
- **Compliance**: TuÃ¢n thá»§ Ä‘Ãºng luáº­t Sam (5 combo types há»£p lá»‡)

### **General Gameplay Model:**
- **Algorithm**: Per-candidate XGBoost classifier (rank-based)
- **Approach**: Rank all legal moves for the current turn and pick the top-scoring move
- **Features**: 22-dim per-candidate features (includes combo type, rank value, breaks_combo_flag, hand context)
- **Performance**: 67.9% turn@1, 80.2% turn@3 on real user data; realistic, non-overfitting

## ğŸ“ Project Structure

```
model_build/
â”œâ”€â”€ ğŸ“‹ docs/                    # Documentation
â”‚   â”œâ”€â”€ README.md              # Usage guide
â”‚   â”œâ”€â”€ OPTIMIZED_GENERAL_MODEL_SOLUTION.md # General gameplay model docs
â”‚   â”œâ”€â”€ HYBRID_CONSERVATIVE_MODEL_DESIGN.md # BÃ¡o SÃ¢m model docs
â”‚   â””â”€â”€ SOLUTION_SUMMARY.md    # Complete solution overview
â”œâ”€â”€ ğŸ”§ models/                 # Model files
â”‚   â”œâ”€â”€ hybrid_conservative_bao_sam_model.pkl # BÃ¡o SÃ¢m model
â”‚   â””â”€â”€ optimized_general_model_v3.pkl # General gameplay model
â”œâ”€â”€ ğŸ“Š data/                   # Data files (optional helpers)
â”‚   â”œâ”€â”€ sam_training_data.jsonl          # BÃ¡o SÃ¢m training data (optional)
â”‚   â”œâ”€â”€ synthetic_training_data.jsonl    # Synthetic data (optional)
â”œâ”€â”€ ğŸ› ï¸ scripts/               # Training & generation scripts
â”‚   â”œâ”€â”€ generate_sam_training_data.py # Generate BÃ¡o SÃ¢m data
â”‚   â”œâ”€â”€ generate_improved_training_data.py # (Optional) Generate synthetic general gameplay data
â”‚   â”œâ”€â”€ train_optimized_model_v3.py        # Format real data and train per-candidate model
â”‚   â””â”€â”€ optimized_general_model_v3.py # General gameplay model implementation
â”œâ”€â”€ formatted_training_data.jsonl   # Exported, formatted general gameplay data (generated by training script)
â”œâ”€â”€ ğŸ§ª tests/                  # Testing & utilities
â”‚   â”œâ”€â”€ test_realistic_scenarios.py # BÃ¡o SÃ¢m test scenarios
â”‚   â””â”€â”€ bao_sam_models.py      # Model utilities
â”œâ”€â”€ hybrid_conservative_model.py # BÃ¡o SÃ¢m model implementation
â”œâ”€â”€ requirements.txt           # Dependencies
â””â”€â”€ __init__.py
```

## ğŸš€ Quick Start

### 1. Install Dependencies
```bash
pip install -r requirements.txt
```

### 2. BÃ¡o SÃ¢m Model

#### Generate Training Data
```bash
python scripts/generate_sam_training_data.py
# Generates: data/sam_training_data.jsonl (1500 records)
```

#### Train Model
```bash
python scripts/retrain_sam_model.py
# Creates: models/hybrid_conservative_bao_sam_model.pkl
```

#### Test Model
```bash
python tests/test_realistic_scenarios.py
# Tests: 10 realistic scenarios, reports accuracy
```

#### Use in Production
```python
import joblib
model = joblib.load('models/hybrid_conservative_bao_sam_model.pkl')

record = {
    'sammove_sequence': [...],  # Combo sequence
    'hand': [...]              # Player's hand
}
result = model.predict_hybrid(record)
```

### 3. General Gameplay Model (Per-Candidate)

#### Train Model (using real gameplay logs)
```bash
python scripts/train_optimized_model_v3.py
# Reads:   training_data.jsonl (from project root)
# Exports: model_build/formatted_training_data.jsonl (rank-based per-candidate format)
# Creates: model_build/models/optimized_general_model_v3.pkl
```

#### Use in Production
```python
from scripts.optimized_general_model_v3 import OptimizedGeneralModelV3

model = OptimizedGeneralModelV3()
model.load('models/optimized_general_model_v3.pkl')

record = {
    'hand': [...],              # Player's hand
    'last_move': {...},         # Last move
    'cards_left': [...],        # Cards left per player
    'meta': {'legal_moves': [...]}  # Available moves
}
result = model.predict(record)  # Per-candidate ranking over legal_moves
```

## ğŸ“Š Performance Metrics

### BÃ¡o SÃ¢m Model Results
- **Precision**: 98.7% â­ (ráº¥t cao, Ã­t false positives)
- **Training Accuracy**: 76.0%
- **CV Accuracy**: 75.3% Â± 1.7%
- **False Positives**: 3 (ráº¥t Ã­t)
- **Rulebase Blocked**: 1244 cases (conservative)
- **Test Scenarios**: 100% (10/10 scenarios)

### General Gameplay Model Results (Per-Candidate)
- **Per-Candidate Sample Accuracy**: 94.18%
- **Turn Accuracy (Top-1)**: 67.9%
- **Turn Accuracy (Top-3)**: 80.2%
- **Notes**: Trained on real user logs; uses rank-based labels (combo_type + rank_value)

## ğŸ¯ Key Features

### BÃ¡o SÃ¢m Model Features
- **Conservative Approach**: Æ¯u tiÃªn precision (98.7%) hÆ¡n recall
- **Rule-based validation**: Cháº·n risky cases
- **Confidence threshold**: Cao (â‰¥ 0.8)
- **Sam Rules Compliance**: Chá»‰ 5 combo types há»£p lá»‡
- **Sequence validation**: Pháº£i Ä‘á»§ 10 lÃ¡ bÃ i

### General Gameplay Model Features
- **Per-candidate Ranking**: XGBoost ranks all legal moves
- **Rank-based Labels**: Uses combo_type + rank_value instead of exact cards
- **Combo Breaking Awareness**: `breaks_combo_flag` pháº¡t xÃ© bá»™ máº¡nh
- **Contextual Signals**: Hand count, cards_left, last_move alignment

## ğŸ“š Documentation

- `docs/OPTIMIZED_GENERAL_MODEL_SOLUTION.md`: General gameplay model documentation
- `docs/HYBRID_CONSERVATIVE_MODEL_DESIGN.md`: BÃ¡o SÃ¢m model technical design
- `docs/SOLUTION_SUMMARY.md`: Complete solution overview
- `docs/RANK_COMBO_DISCUSSION.md`: Combo strength calculation details

## ğŸ”§ Model Configuration

### BÃ¡o SÃ¢m Model
```python
DecisionTreeClassifier(
    max_depth=12,            # Increased depth for better learning
    min_samples_split=10,    # Reduced split threshold
    min_samples_leaf=5,      # Reduced leaf threshold
    criterion='entropy',     
    class_weight={0:1, 1:2}, # Balanced class weights
    random_state=42
)
```

### General Gameplay Model (Per-Candidate XGBoost)
```python
import xgboost as xgb

xgb.XGBClassifier(
    max_depth=6,
    learning_rate=0.1,
    n_estimators=300,
    subsample=0.9,
    colsample_bytree=0.9,
    reg_alpha=0.1,
    reg_lambda=1.0,
    random_state=42,
    eval_metric='logloss'
)
```

---

*Both models are integrated in production via `GeneralPlayProvider` (general) and `ProductionBaoSamProvider` (BÃ¡o SÃ¢m).*

**Last Updated**: 2025-09-17  
**Status**: âœ… ACTIVE - Per-candidate general gameplay + Hybrid BÃ¡o SÃ¢m  
**Models**: BÃ¡o SÃ¢m (Hybrid Conservative) + General Gameplay (Optimized V3 Per-Candidate)

